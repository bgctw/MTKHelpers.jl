<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Updating problems · MTKHelpers.jl</title><meta name="title" content="Updating problems · MTKHelpers.jl"/><meta property="og:title" content="Updating problems · MTKHelpers.jl"/><meta property="twitter:title" content="Updating problems · MTKHelpers.jl"/><meta name="description" content="Documentation for MTKHelpers.jl."/><meta property="og:description" content="Documentation for MTKHelpers.jl."/><meta property="twitter:description" content="Documentation for MTKHelpers.jl."/><meta property="og:url" content="https://bgctw.github.io/MTKHelpers.jl/updating_problems/"/><meta property="twitter:url" content="https://bgctw.github.io/MTKHelpers.jl/updating_problems/"/><link rel="canonical" href="https://bgctw.github.io/MTKHelpers.jl/updating_problems/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">MTKHelpers.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Update parameters</span><ul><li class="is-active"><a class="tocitem" href>Updating problems</a><ul class="internal"><li><a class="tocitem" href="#ProblemUpdater"><span>ProblemUpdater</span></a></li></ul></li><li><a class="tocitem" href="../problemupdater/">ProblemUpdater</a></li><li><a class="tocitem" href="../odeproblemparsetter/">ODEProblem</a></li><li><a class="tocitem" href="../concrete_parupdater/">Type inference</a></li></ul></li><li><a class="tocitem" href="../system_num_dict_scalar/">Translating symbols and Nums</a></li><li><a class="tocitem" href="../embed_system/">Embedding a system</a></li><li><a class="tocitem" href="../solution/">Solution handling</a></li><li><a class="tocitem" href="../smoothstep/">Smooth steps</a></li><li><a class="tocitem" href="../cairomakie/">CairoMakie Helpers</a></li><li><a class="tocitem" href="../write_csv_cv/">Writing/Reading ComponentVectors</a></li><li><span class="tocitem">Developer notes</span><ul><li><a class="tocitem" href="../pde_dev/">PDE support</a></li></ul></li><li><a class="tocitem" href="../zindex/">index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Update parameters</a></li><li class="is-active"><a href>Updating problems</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Updating problems</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/bgctw/MTKHelpers.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/bgctw/MTKHelpers.jl/blob/main/docs/src/updating_problems.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Setting-Initial-state-and-Parameters-of-a-problem"><a class="docs-heading-anchor" href="#Setting-Initial-state-and-Parameters-of-a-problem">Setting Initial state and Parameters of a problem</a><a id="Setting-Initial-state-and-Parameters-of-a-problem-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-Initial-state-and-Parameters-of-a-problem" title="Permalink"></a></h1><p>Often one wants to change a subset of the initial states,<code>u0</code>, and a subset of parameters,<code>p</code>, of an AbstractODEProblem during an optimization.</p><p>Given <code>u0</code> and <code>p</code> can be expressed as ComponentVectors,  then <code>popt</code> can be expressed as a ComponentVector of optimized parameters,  which may include initial states. The initial states and parameter components  must have different names.</p><pre><code class="language-julia hljs">#The following example system employs a scalar and a vector-valued parameter.
# using ModelingToolkit, OrdinaryDiffEq, ComponentArrays
# using MTKHelpers
# using ModelingToolkit: t_nounits as t, D_nounits as D
# function samplesystem(;name,τ = 3.0, p=[1.1, 1.2])
#     sts = @variables x(t) RHS(t)        # RHS is observed
#     ps = @parameters τ=τ p[1:2] = p
#     ODESystem([ RHS  ~ p[1] + -p[2]*x + (1 - x)/τ, D(x) ~ RHS ], t, sts, vcat(ps...); name)
# end
# @named m = samplesystem()
# @named sys = embed_system(m)
# prob = ODEProblem(sys, [m.x =&gt; 0.0], (0.0,10.0))</code></pre><pre><code class="language-julia hljs">#The following example system employs a scalar and a vector-valued parameter.
using ModelingToolkit, OrdinaryDiffEq, ComponentArrays
using ModelingToolkit: ModelingToolkit as MTK
using MTKHelpers
using ModelingToolkit: t_nounits as t, D_nounits as D
function samplesystem(;name,τ = 3.0, p1=1.1, p2=1.2)
    sts = @variables x(t) RHS(t)        # RHS is observed
    ps = @parameters τ=τ p1 = p1 p2 = p2
    System([ RHS  ~ p1 + -p2*x + (1 - x)/τ, D(x) ~ RHS ], t, sts, vcat(ps...); name)
end
@named m = samplesystem()
@named sys = embed_system(m)
prob = ODEProblem(sys, [m.x =&gt; 0.0], (0.0,10.0))</code></pre><p>An <a href="../odeproblemparsetter/#ODEProblemParSetter"><code>ODEProblemParSetter</code></a> then can be used to update a subset of states and parameters in the derived problem. Because the state of the problem can reorder components of a symbolic array and the parameter object of the problem is complex, use functions <code>get_par(pset, prob)</code> and <code>get_state(pset, prob)</code> or their labeled versions to  inspect state and parameters of a problem.</p><pre><code class="language-julia hljs"># setup position matching, note τ is not in parameters optimized
popt = ComponentVector(state=(m₊x=0.1,), par=(m₊p1=2.1,m₊p2=2.2))
pset = ODEProblemParSetter(sys, popt)

# extract optimized
get_paropt(pset, prob)          # plain vector
get_paropt_labeled(pset, prob)  # ComponentVector
name_paropt(pset, prob)         # NamedVector

# update states and parameters
prob2 = remake(prob, popt, pset)
get_par_labeled(pset, prob2).m₊p2 == popt.par.m₊p2 # attach labels and access properties
get_state_labeled(pset, prob2).m₊x == popt.state.m₊x # attach labels and access properties
get_paropt_labeled(pset, prob2) == popt</code></pre><p>There are three  <a href="https://docs.sciml.ai/ModelingToolkit/stable/basics/FAQ/#Why-are-my-parameters-some-obscure-object?">suggested ways in MTK10</a> is to</p><ul><li>using an index object</li><li>using a setter object</li><li>using a SciMLStructures.jl to replace all tunable parameters</li></ul><p>The first two, currently, do not work with AD systems. The third requires changing the system definition to adapt the parameters.</p><pre><code class="language-julia hljs">#prob2 = remake(prob, [m.p2 =&gt; 3.2]) # would be nice, but not supported
ip2 = MTK.parameter_index(sys, MTK.parse_variable(sys, &quot;m₊p2&quot;))
setindex!(prob.ps, 3.2, ip2)
prob.ps[m.p2] == 3.2</code></pre><p>Alternatively, <a href="https://docs.sciml.ai/ModelingToolkit/stable/basics/FAQ/#Using-ModelingToolkit-with-Optimization-/-Automatic-Differentiation">use setter!</a>  from <a href="https://docs.sciml.ai/SymbolicIndexingInterface/stable/">SymbolicIndexingInterface.jl</a> But this currently does not work with AD systems in Optimization.</p><pre><code class="language-julia hljs">using SymbolicIndexingInterface
setter! = setp(sys, [m.p2])
setter!(prob, 4.2)
prob.ps[m.p2] == 4.2</code></pre><p>Note that produced labeled ComponentArrays are not fully type-inferred, unless a concrete versions of the ParameterSetter and function barriers are used as described  in <a href="../concrete_parupdater/#Concrete-ProblemUpdater">Concrete ProblemUpdater</a>.</p><h2 id="ProblemUpdater"><a class="docs-heading-anchor" href="#ProblemUpdater">ProblemUpdater</a><a id="ProblemUpdater-1"></a><a class="docs-heading-anchor-permalink" href="#ProblemUpdater" title="Permalink"></a></h2><p>A <a href="../odeproblemparsetter/#ODEProblemParSetterConcrete"><code>ODEProblemParSetterConcrete</code></a> can be combined with a <a href="../problemupdater/#MTKHelpers.KeysProblemParGetter"><code>KeysProblemParGetter</code></a> or another specific implementation of <a href="../problemupdater/#MTKHelpers.AbstractProblemParGetter"><code>AbstractProblemParGetter</code></a> to  update an AbstractODEProblem based on information already present in the AbstractODEProblem.</p><p>The following example updates parameters <code>k_R</code> and <code>k_P</code> in the AbstractODEProblem to the value of <code>k_L</code>. This can be useful to ensure that these parameters are also changed when optimizing parameter <code>k_L</code>.</p><p>An implementations of <code>AbstractProblemParGetter</code> can use any computation of the source keys to provide its destination keys. It should implement the keys method, so that when constructing the ProblemUpdater, consistent keys are used, as in the example below.</p><p>First, create an example system and example problem.</p><pre><code class="language-julia hljs">using ModelingToolkit, OrdinaryDiffEq, ComponentArrays
using MTKHelpers
function get_sys1()
    sts = @variables L(t)
    ps = @parameters k_L, k_R, k_P
    eq = [D(L) ~ 0]
    sys1 = ODESystem(eq, t, sts, vcat(ps...); name = :sys1)
end
sys1 = mtkcompile(get_sys1())
u0 = ComponentVector(L = 10.0)
p = ComponentVector(k_L = 1.0, k_R = 1 / 20, k_P = 2.0)
prob = ODEProblem(sys1,
    get_system_symbol_dict(sys1, u0), (0.0, 1.0),
    get_system_symbol_dict(sys1, p))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr33"><span class="sgr1">┌ Warning: </span></span>`SciMLBase.ODEProblem(sys, u0, tspan, p; kw...)` is deprecated. Use
<span class="sgr33"><span class="sgr1">│ </span></span>`SciMLBase.ODEProblem(sys, merge(Dict(u0), Dict(p)), tspan)` instead.
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ ModelingToolkit ~/.julia/packages/ModelingToolkit/kD28h/src/deprecations.jl:45</span></code></pre><p>Next, setup a ProblemUpdater, <code>pu</code>, and apply it to the problem via <code>prob2 = pu(prob)</code>.</p><pre><code class="language-julia hljs">mapping = (:k_L =&gt; :k_R, :k_L =&gt; :k_P)
pu = get_ode_problemupdater(KeysProblemParGetter(mapping, keys(u0)), get_system(prob))
prob2 = pu(prob)
p2 = get_par_labeled(par_setter(pu), prob2)
p2.k_P == p.k_L
p2.k_R == p.k_L</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../problemupdater/">ProblemUpdater »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Tuesday 7 October 2025 16:35">Tuesday 7 October 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
